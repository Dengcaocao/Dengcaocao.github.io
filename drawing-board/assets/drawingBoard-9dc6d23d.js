import{d as W,r as x,a as M,c as $,o as k,b as C,e as m,w as S,v as z,u,n as L,f as y,F as B,g as G,h as X,i as j,j as I,k as Y}from"./index-078afe7c.js";const T=W("ctx",()=>{const v=x(!0),p=M({mode:"line",color:"#000000",lineWidth:1,lineCap:"round"});return{isGrid:v,ctx:p,updateIsGrid:()=>v.value=!v.value,updateCtx:(e,a)=>{p[e]=a}}}),w=T();function R(){class v{constructor(t){this.canvas=t,this.ctx=t.value.getContext("2d"),this.pathStore=[],this.revokePathStore=[],this.type="stroke",this.path=new Path2D,this.contextOptions=null}init(t){this.startPoint=t,this.lastPoint=t,this.ctx.moveTo(t.x,t.y)}line(t,n){this.ctx.beginPath(),this.path=new Path2D,this.path.moveTo(this.lastPoint.x,this.lastPoint.y),this.path.lineTo(t,n),this.type="stroke",this.draw(),this.ctx.closePath(),this.lastPoint={x:t,y:n}}arc(t,n){this.path=new Path2D;const e=t-this.startPoint.x,a=n-this.startPoint.y,s=this.startPoint.x+e/2,i=this.startPoint.y+a/2,h=Math.pow(e*e+a*a,1/2);this.path.arc(s,i,h/2,0,Math.PI*2),this.type="stroke",this.draw()}rect(t,n){this.path=new Path2D;const e=t-this.startPoint.x,a=n-this.startPoint.y;this.path.rect(this.startPoint.x,this.startPoint.y,e,a),this.type="stroke",this.draw()}getMarkSize(t){const n=t/4;switch(!0){case t<100:return{w:1,h:n<2?2:n,incline:2,size:n<2?2:n/2};default:return{w:4,h:20,incline:4,size:10}}}mark(t,n){this.ctx.save(),this.path=new Path2D;const e=t-this.startPoint.x,a=n-this.startPoint.y,s=e<0?-1:1,i=Math.pow(e*e+a*a,1/2)*s;let h=Math.asin(Math.sin(a/i));this.setContextOptions({translate:{x:this.startPoint.x,y:this.startPoint.y},rotate:h});const o=this.getMarkSize(Math.abs(i));this.path.lineTo(0,0),this.path.lineTo(0,-o.w/2),this.path.lineTo(i-o.h*s,-o.size),this.path.lineTo(i-o.h*s-o.incline*s,-o.size*2),this.path.lineTo(i,0),this.path.lineTo(i-o.h*s-o.incline*s,o.size*2),this.path.lineTo(i-o.h*s,o.size),this.path.lineTo(0,o.w/2),this.path.lineTo(0,0),this.type="fill",this.draw(),this.ctx.restore()}text(t,n,e){const s=document.createElement("textarea");s.cols=1,s.rows=1,this.setContextOptions({font:"32px auto",textBaseline:"middle"}),s.oninput=i=>{this.clearCanvas(),this.reDraw(),s.cols=i.target.value.length+1,this.ctx.fillText(i.target.value,t+2,n)},s.onblur=i=>{this.type="fill",this.path={x:t+2,y:n,text:i.target.value},i.target.value&&this.savePath(),s.parentNode.removeChild(s)},s.style.cssText=`
        overflow: hidden;
        position: absolute;
        top: ${n-32/2}px;
        left: ${t}px;
        height: 32px;
        line-height: 32px;
        background-color: transparent;
        outline: none;
        resize: none;
        border: 1px solid #000;
        font-size: 32px;
        white-space: pre-wrap;
        text-indent: 2px;
        color: transparent;
        caret-color: #000;
      `,e.value.appendChild(s)}reDraw(){this.pathStore.forEach(({type:t,contextOptions:n,path:e})=>{e.text?this.ctx.fillText(e.text,e.x,e.y):(this.type=t,this.contextOptions=n,this.path=e,this.draw(!0)),this.contextOptions=null})}clear(t,n){this.ctx.save(),this.path=new Path2D,this.setContextOptions({globalCompositeOperation:"destination-out"}),this.path.moveTo(this.lastPoint.x,this.lastPoint.y),this.path.lineTo(t,n),this.type="stroke",this.draw(),this.lastPoint={x:t,y:n},this.ctx.restore()}revoke(){if(!this.pathStore.length)return;this.clearCanvas();const t=this.pathStore.pop();this.revokePathStore.push(t),this.reDraw()}forward(){if(!this.revokePathStore.length)return;this.clearCanvas();const t=this.revokePathStore.pop();this.pathStore.push(t),this.reDraw()}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.value.width,this.canvas.value.height)}setContextOptions(t){for(let n in t){if(n==="translate"){this.ctx[n](t[n].x,t[n].y);continue}if(n==="rotate"){this.ctx[n](t[n]);continue}this.ctx[n]=t[n]}this.contextOptions={...this.contextOptions,...t}}draw(t){this.ctx.save(),this.ctx.beginPath(),t?this.setContextOptions(this.contextOptions):this.setContextOptions({strokeStyle:w.ctx.color,fillStyle:w.ctx.color,lineWidth:w.ctx.mode==="clear"&&w.ctx.lineWidth<10?10:w.ctx.lineWidth,lineCap:w.ctx.lineCap}),this.type==="stroke"?this.ctx.stroke(this.path):this.ctx.fill(this.path),this.ctx.closePath(),this.ctx.restore()}savePath(){this.pathStore.push({type:this.type,contextOptions:this.contextOptions||{},path:this.path}),this.contextOptions=null,this.type="stroke"}}return{Draw:v}}const U=["max"],V={class:"item"},A=["onClick"],N={__name:"actionBar",props:{actions:{type:Object,required:!0}},setup(v){const p=v,t=T(),n=x(!1),e=x(null),a=x(50),s=M([{icon:"icon-juxing1",type:"rect"},{icon:"icon-yuanxingweixuanzhong",type:"arc"},{icon:"icon-jiantou_youshang",type:"mark"},{icon:"icon-Icon_huabi",type:"line"},{icon:"icon-wenzi",type:"text"},{icon:"icon-chexiao",type:"revoke"},{icon:"icon-chexiao",type:"forward"},{icon:"icon-rubber-full",type:"clear"},{icon:"icon-xiazai-",type:"download"}]),i=$(()=>e.value?getComputedStyle(e.value).height:0),h=(o,r)=>{if(["revoke","forward","download"].includes(r))return p.actions[r]();t.updateCtx(o,r)};return(o,r)=>(k(),C("aside",null,[m("div",{class:y(["tabbar",{collapsed:n.value}]),ref_key:"tabbar",ref:e},[S(m("input",{class:"line-width",type:"range","onUpdate:modelValue":r[0]||(r[0]=c=>u(t).ctx.lineWidth=c),max:a.value,style:L({width:i.value,"background-image":`linear-gradient(to right, #91caff ${u(t).ctx.lineWidth/a.value*100+"%"}, transparent ${u(t).ctx.lineWidth/100*100+"%"})`}),onChange:r[1]||(r[1]=c=>h("lineWidth",c.target.value))},null,44,U),[[z,u(t).ctx.lineWidth]]),m("div",{class:y(["item iconfont icon-wangge",{"hide-grid":!u(t).isGrid}]),onClick:r[2]||(r[2]=(...c)=>u(t).updateIsGrid&&u(t).updateIsGrid(...c))},null,2),m("div",V,[S(m("input",{class:"color",type:"color","onUpdate:modelValue":r[3]||(r[3]=c=>u(t).ctx.color=c),onChange:r[4]||(r[4]=c=>h("color",c.target.value))},null,544),[[z,u(t).ctx.color]])]),(k(!0),C(B,null,G(s,c=>(k(),C("div",{class:y(["item iconfont",[c.icon,u(t).ctx.mode===c.type?"active":""]]),key:c.type,style:L({transform:c.type==="forward"&&"scaleX(-1)"}),onClick:X(g=>h("mode",c.type),["stop"])},null,14,A))),128))],2),m("div",{class:y(["collapsed-btn iconfont icon-jiantou_yemian_xiangzuo_o",{overturn:n.value}]),onClick:r[5]||(r[5]=c=>n.value=!n.value)},null,2)]))}};const H={__name:"drawingBoard",setup(v){const p=T(),{Draw:t}=R(),n=x(),e=x(),a=x({});let s=null,i=0;const h=()=>{const{clientWidth:l,clientHeight:d}=document.documentElement;e.value.width=l,e.value.height=d,s.reDraw()},o=x(!1),r=()=>{const l=e.value.toDataURL(),d=document.createElement("a");d.setAttribute("href",l),d.setAttribute("download",Math.random().toString(16).slice(-6)),d.click()},c=()=>({revoke:()=>s.revoke(),forward:()=>s.forward(),download:r}),g=l=>{o.value=!0,i=new Date().getTime();const{clientX:d,clientY:P}=l;s.init({x:d,y:P}),p.ctx.mode==="text"&&(o.value=!1,s.text(d,P,n))},_=l=>{if(!o.value)return;const{clientX:d,clientY:P}=l;s.clearCanvas(),["line","clear"].includes(p.ctx.mode)&&s.savePath(),s.reDraw(),s[p.ctx.mode](d,P)},f=()=>{o.value=!1,new Date().getTime()-i>200&&s.savePath(),i=0},b=l=>g(l.changedTouches[0]),D=l=>_(l.changedTouches[0]),E=f,O=()=>{e.value.addEventListener("mousedown",g),e.value.addEventListener("mousemove",_),e.value.addEventListener("onmouseleave",f),e.value.addEventListener("mouseup",f),e.value.addEventListener("touchstart",b),e.value.addEventListener("touchmove",D),e.value.addEventListener("touchend",E)};return j(()=>{s=new t(e),h(),O(),a.value=c(),window.addEventListener("resize",h)}),I(()=>{e.value.removeEventListener("mousedown",g),e.value.removeEventListener("mousemove",_),e.value.removeEventListener("onmouseleave",f),e.value.removeEventListener("mouseup",f),e.value.removeEventListener("touchstart",b),e.value.removeEventListener("touchmove",D),e.value.removeEventListener("touchend",E),window.removeEventListener("resize",h)}),(l,d)=>(k(),C("main",{ref_key:"canvasRoot",ref:n},[m("canvas",{ref_key:"cDom",ref:e,class:y(["canvas",{"show-grid":u(p).isGrid}])},null,2),Y(N,{actions:a.value},null,8,["actions"])],512))}};export{H as default};
