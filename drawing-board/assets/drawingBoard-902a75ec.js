import{d as L,r as y,a as I,c as $,o as k,b as C,e as f,w as D,v as E,u as p,n as O,f as g,F as B,g as W,h as X,i as Y,j as G,k as j}from"./index-0b41ac52.js";const b=L("ctx",()=>{const v=y(!0),l=I({mode:"line",color:"#000000",lineWidth:1,lineCap:"round"});return{isGrid:v,ctx:l,updateIsGrid:()=>v.value=!v.value,updateCtx:(e,o)=>{l[e]=o}}}),x=b();function R(){class v{constructor(t){this.canvas=t,this.ctx=t.value.getContext("2d"),this.isCreateInput=!1,this.pathStore=[],this.revokePathStore=[],this.bones=[],this.path=new Path2D,this.type="stroke",this.contextOptions=null}init(t){this.startPoint=t,this.lastPoint=t,this.ctx.moveTo(t.x,t.y)}line(t,n){this.path=new Path2D,this.path.moveTo(this.lastPoint.x,this.lastPoint.y),this.path.lineTo(t,n),this.type="stroke",this.draw(),this.lastPoint={x:t,y:n}}arc(t,n){this.path=new Path2D;const e=t-this.startPoint.x,o=n-this.startPoint.y,s=this.startPoint.x+e/2,i=this.startPoint.y+o/2,a=Math.pow(e*e+o*o,1/2)/2;this.bones=[[s-a,i-a],[s,i-a],[s+a,i-a],[s+a,i],[s+a,i+a],[s,i+a],[s-a,i+a],[s-a,i]],this.path.arc(s,i,a,0,Math.PI*2),this.type="stroke",this.rotatePoint={x:s,y:i},this.draw()}rect(t,n){this.path=new Path2D;const{x:e,y:o}=this.startPoint,s=t-e,i=n-o;this.bones=[[e,o],[e+s/2,o],[e+s,o],[e+s,o+i/2],[e+s,o+i],[e+s/2,o+i],[e,o+i],[e,o+i/2]],this.path.rect(e,o,s,i),this.type="stroke",this.rotatePoint={x:s/2,y:i/2},this.draw()}getMarkSize(t){const n=t/4;switch(!0){case t<100:return{w:1,h:n<2?2:n,incline:2,size:n<2?2:n/2};default:return{w:4,h:20,incline:4,size:10}}}mark(t,n){this.ctx.save(),this.ctx.beginPath(),this.path=new Path2D;const e=t-this.startPoint.x,o=n-this.startPoint.y,s=e<0?-1:1,i=Math.pow(e*e+o*o,1/2)*s;let a=Math.atan2(o,e);s===-1&&(a=o<0?-Math.PI+a:Math.PI+a),this.setContextOptions({translate:{x:this.startPoint.x,y:this.startPoint.y},rotate:a});const r=this.getMarkSize(Math.abs(i));this.path.lineTo(0,0),this.path.lineTo(0,-r.w/2),this.path.lineTo(i-r.h*s,-r.size),this.path.lineTo(i-r.h*s-r.incline*s,-r.size*2),this.path.lineTo(i,0),this.path.lineTo(i-r.h*s-r.incline*s,r.size*2),this.path.lineTo(i-r.h*s,r.size),this.path.lineTo(0,r.w/2),this.path.lineTo(0,0),this.bones=[[0,-r.size*2],[i/2,-r.size*2],[i,-r.size*2],[i,0],[i,r.size*2],[i/2,r.size*2],[0,r.size*2],[0,0]],this.type="fill",this.rotatePoint={x:0,y:0},this.draw(),this.ctx.closePath(),this.ctx.restore()}text(t,n,e){if(this.isCreateInput=!this.isCreateInput,!this.isCreateInput)return;const o=document.createElement("input"),s=28,i=n-s/2;let a=0;o.spellcheck=!1,setTimeout(()=>o.focus(),0),this.type="fill",this.ctx.save(),o.oninput=r=>{this.clearCanvas(),this.reDraw(),this.setContextOptions({font:`${s}px auto`,textBaseline:"middle",fillStyle:x.ctx.color}),a=this.ctx.measureText(r.target.value).width,o.style.width=`${a}px`,o.style.textIndent=`${a}px`,this.bones=[[t,i],[t+a/2,i],[t+a,i],[t+a,n],[t+a,n+s/2],[t+a/2,n+s/2],[t,n+s/2],[t,n]],this.rotatePoint={x:a/2,y:s/2},this.ctx.fillText(r.target.value,t,n)},o.onblur=r=>{this.isCreateInput=!1;const h=new Path2D;h.rect(t,i,a,s),this.path={x:t,y:n,text:r.target.value,vPath:h},this.ctx.restore(),r.target.value&&this.savePath(),o.parentNode.removeChild(o)},o.style.cssText=`
        position: absolute;
        top: ${n-s/2-6}px;
        left: ${t-6}px;
        height: ${s}px;
        width: ${s}px;
        min-width: ${s}px;
        padding: 4px;
        font-size: ${s}px;
        color: transparent;
        caret-color: ${x.ctx.color};
        outline: none;
        border-radius: 4px;
        border: 2px solid ${x.ctx.color};
        background-color: transparent;
        box-shadow: inset 0px 0px 5px 2px rgba(0, 0, 0, 0);
      `,e.value.appendChild(o)}reDraw(){this.pathStore.forEach(({type:t,contextOptions:n,path:e})=>{e.text?(this.ctx.save(),this.setContextOptions(n),this.ctx.fillText(e.text,e.x,e.y),this.ctx.restore()):(this.type=t,this.contextOptions=n,this.path=e,this.draw(!0)),this.contextOptions=null})}clear(t,n){this.ctx.save(),this.path=new Path2D,this.setContextOptions({globalCompositeOperation:"destination-out"}),this.path.moveTo(this.lastPoint.x,this.lastPoint.y),this.path.lineTo(t,n),this.type="stroke",this.draw(),this.lastPoint={x:t,y:n},this.ctx.restore()}revoke(){if(!this.pathStore.length)return;this.clearCanvas();const t=this.pathStore.pop();this.revokePathStore.push(t),this.reDraw()}forward(){if(!this.revokePathStore.length)return;this.clearCanvas();const t=this.revokePathStore.pop();this.pathStore.push(t),this.reDraw()}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.value.width,this.canvas.value.height)}setContextOptions(t){for(let n in t){if(n==="translate"){this.ctx[n](t[n].x,t[n].y);continue}if(n==="rotate"){this.ctx[n](t[n]);continue}this.ctx[n]=t[n]}this.contextOptions={...this.contextOptions,...t}}showBones(t,n){this.ctx.save(),this.ctx.beginPath();for(let e=0;e<=t.length;e++){const o=e%t.length,[s,i]=t[o];this.ctx.save(),this.setContextOptions({...n,lineWidth:1,fillStyle:"#fff",strokeStyle:"rgba(0, 0, 0, .8)"}),this.ctx.moveTo(s,i),this.ctx.arc(s,i,3,0,Math.PI*2),this.ctx.moveTo(s,i);const[a,r]=t[o+1]||t[0];this.ctx.lineTo(a,r),this.ctx.stroke(),this.ctx.fill(),this.ctx.restore()}this.contextOptions=null,this.ctx.closePath(),this.ctx.restore()}checkPointInPath(t){this.clearCanvas(),this.reDraw();const n=t?{x:t.x-this.lastPoint.x,y:t.y-this.lastPoint.y}:{x:0,y:0};t&&(this.lastPoint=t);for(let e=this.pathStore.length-1;e>=0;e--){const o=this.pathStore[e].path;this.pathStore[e].rotatePoint;const s=this.pathStore[e].contextOptions,i=s.translate||{x:0,y:0};let a=t?t.x-i.x:this.startPoint.x-i.x,r=t?t.y-i.y:this.startPoint.y-i.y;s.rotate;const h=this.ctx.isPointInPath(o.text?o.vPath:o,a,r);if(t||(this.pathStore[e].isShowBones=h),this.pathStore[e].isShowBones){const c=this.pathStore[e].bones;return s.translate={x:t?i.x+n.x:i.x,y:t?i.y+n.y:i.y},this.pathStore[e].contextOptions=s,this.showBones(c,s)}}}draw(t){this.ctx.save(),this.ctx.beginPath(),t?this.setContextOptions(this.contextOptions):this.setContextOptions({strokeStyle:x.ctx.color,fillStyle:x.ctx.color,lineWidth:x.ctx.mode==="clear"&&x.ctx.lineWidth<10?10:x.ctx.lineWidth,lineCap:x.ctx.lineCap}),this.type==="stroke"?this.ctx.stroke(this.path):this.ctx.fill(this.path),this.ctx.closePath(),this.ctx.restore()}savePath(){this.path&&(this.pathStore.push({type:this.type,rotatePoint:this.rotatePoint,contextOptions:this.contextOptions||{},path:this.path,bones:this.bones,isShowBones:!1}),this.path=null,this.bones=[],this.type="stroke",this.rotatePoint=null,this.contextOptions=null)}}return{Draw:v}}const U=["max"],V={class:"item"},A=["onClick"],N={__name:"actionBar",props:{actions:{type:Object,required:!0}},setup(v){const l=v,t=b(),n=y(!1),e=y(null),o=y(50),s=I([{icon:"icon-juxing1",type:"rect"},{icon:"icon-yuanxingweixuanzhong",type:"arc"},{icon:"icon-jiantou_youshang",type:"mark"},{icon:"icon-Icon_huabi",type:"line"},{icon:"icon-wenzi",type:"text"},{icon:"icon-chexiao",type:"revoke"},{icon:"icon-chexiao",type:"forward"},{icon:"icon-rubber-full",type:"clear"},{icon:"icon-xuanze",type:"pick"},{icon:"icon-xiazai-",type:"download"}]),i=$(()=>e.value?getComputedStyle(e.value).height:0),a=(r,h)=>{if(["revoke","forward","download"].includes(h))return l.actions[h]();t.updateCtx(r,h)};return(r,h)=>(k(),C("aside",null,[f("div",{class:g(["tabbar",{collapsed:n.value}]),ref_key:"tabbar",ref:e},[D(f("input",{class:"line-width",type:"range","onUpdate:modelValue":h[0]||(h[0]=c=>p(t).ctx.lineWidth=c),max:o.value,style:O({width:i.value,"background-image":`linear-gradient(to right, #91caff ${p(t).ctx.lineWidth/o.value*100+"%"}, transparent ${p(t).ctx.lineWidth/100*100+"%"})`}),onChange:h[1]||(h[1]=c=>a("lineWidth",c.target.value))},null,44,U),[[E,p(t).ctx.lineWidth]]),f("div",{class:g(["item iconfont icon-wangge",{"hide-grid":!p(t).isGrid}]),onClick:h[2]||(h[2]=(...c)=>p(t).updateIsGrid&&p(t).updateIsGrid(...c))},null,2),f("div",V,[D(f("input",{class:"color",type:"color","onUpdate:modelValue":h[3]||(h[3]=c=>p(t).ctx.color=c),onChange:h[4]||(h[4]=c=>a("color",c.target.value))},null,544),[[E,p(t).ctx.color]])]),(k(!0),C(B,null,W(s,c=>(k(),C("div",{class:g(["item iconfont",[c.icon,p(t).ctx.mode===c.type?"active":""]]),key:c.type,style:O({transform:c.type==="forward"&&"scaleX(-1)"}),onClick:X(P=>a("mode",c.type),["stop"])},null,14,A))),128))],2),f("div",{class:g(["collapsed-btn iconfont icon-jiantou_yemian_xiangzuo_o",{overturn:n.value}]),onClick:h[5]||(h[5]=c=>n.value=!n.value)},null,2)]))}};const H={__name:"drawingBoard",setup(v){const l=b(),{Draw:t}=R(),n=y(),e=y(),o=y({});let s=null,i=0;const a=()=>{const{clientWidth:u,clientHeight:d}=document.documentElement;e.value.width=u,e.value.height=d,s.reDraw()},r=y(!1),h=()=>{const u=e.value.toDataURL(),d=document.createElement("a");d.setAttribute("href",u),d.setAttribute("download",Math.random().toString(16).slice(-6)),d.click()},c=()=>({revoke:()=>s.revoke(),forward:()=>s.forward(),download:h}),P=u=>{r.value=!0,i=new Date().getTime();const{clientX:d,clientY:m}=u;s.init({x:d,y:m}),l.ctx.mode==="text"&&(r.value=!1,s.text(d,m,n)),l.ctx.mode==="pick"&&s.checkPointInPath()},S=u=>{if(!r.value)return;const{clientX:d,clientY:m}=u;if(l.ctx.mode==="pick")return s.checkPointInPath({x:d,y:m});s.clearCanvas(),["line","clear"].includes(l.ctx.mode)&&s.savePath(),s.reDraw(),s[l.ctx.mode](d,m)},w=()=>{r.value=!1,new Date().getTime()-i>200&&l.ctx.mode!=="pick"&&s.savePath(),i=0},T=u=>P(u.changedTouches[0]),_=u=>S(u.changedTouches[0]),z=w,M=()=>{e.value.addEventListener("mousedown",P),e.value.addEventListener("mousemove",S),e.value.addEventListener("onmouseleave",w),e.value.addEventListener("mouseup",w),e.value.addEventListener("touchstart",T),e.value.addEventListener("touchmove",_),e.value.addEventListener("touchend",z)};return Y(()=>{s=new t(e),a(),M(),o.value=c(),window.addEventListener("resize",a)}),G(()=>{e.value.removeEventListener("mousedown",P),e.value.removeEventListener("mousemove",S),e.value.removeEventListener("onmouseleave",w),e.value.removeEventListener("mouseup",w),e.value.removeEventListener("touchstart",T),e.value.removeEventListener("touchmove",_),e.value.removeEventListener("touchend",z),window.removeEventListener("resize",a)}),(u,d)=>(k(),C("main",{ref_key:"canvasRoot",ref:n},[f("canvas",{ref_key:"cDom",ref:e,class:g(["canvas",{"show-grid":p(l).isGrid}])},null,2),j(N,{actions:o.value},null,8,["actions"])],512))}};export{H as default};
