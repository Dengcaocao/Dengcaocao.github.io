import{d as W,r as w,a as O,o as I,n as B,b as L,c as S,e as T,f as g,g as _,w as E,v as M,u as x,h as C,F as X,i as Y,j as G,k as j}from"./index-287d946d.js";const z=W("ctx",()=>{const m=w(!0),l=O({mode:"line",color:"#000000",lineWidth:1,lineCap:"round"});return{isGrid:m,ctx:l,updateIsGrid:()=>m.value=!m.value,updateCtx:(e,o)=>{l[e]=o}}}),f=z();function R(){class m{constructor(t){this.canvas=t,this.ctx=t.value.getContext("2d"),this.isCreateInput=!1,this.pathStore=[],this.revokePathStore=[],this.bones=[],this.path=new Path2D,this.type="stroke",this.contextOptions=null}init(t){this.startPoint=t,this.lastPoint=t,this.ctx.moveTo(t.x,t.y)}line(t,i){this.path=new Path2D,this.path.moveTo(this.lastPoint.x,this.lastPoint.y),this.path.lineTo(t,i),this.type="stroke",this.draw(),this.lastPoint={x:t,y:i}}arc(t,i){this.path=new Path2D;const e=t-this.startPoint.x,o=i-this.startPoint.y,s=this.startPoint.x+e/2,n=this.startPoint.y+o/2,r=Math.pow(e*e+o*o,1/2)/2;this.bones=[[s-r,n-r],[s,n-r],[s+r,n-r],[s+r,n],[s+r,n+r],[s,n+r],[s-r,n+r],[s-r,n]],this.path.arc(s,n,r,0,Math.PI*2),this.type="stroke",this.rotatePoint={x:s,y:n},this.draw()}rect(t,i){this.path=new Path2D;const{x:e,y:o}=this.startPoint,s=t-e,n=i-o;this.bones=[[e,o],[e+s/2,o],[e+s,o],[e+s,o+n/2],[e+s,o+n],[e+s/2,o+n],[e,o+n],[e,o+n/2]],this.path.rect(e,o,s,n),this.type="stroke",this.rotatePoint={x:s/2,y:n/2},this.draw()}getMarkSize(t){const i=t/4;switch(!0){case t<100:return{w:1,h:i<2?2:i,incline:2,size:i<2?2:i/2};default:return{w:4,h:20,incline:4,size:10}}}mark(t,i){this.ctx.save(),this.path=new Path2D;const e=t-this.startPoint.x,o=i-this.startPoint.y,s=e<0?-1:1,n=Math.pow(e*e+o*o,1/2)*s;let r=Math.atan2(o,e);s===-1&&(r=o<0?-Math.PI+r:Math.PI+r),this.setContextOptions({translate:{x:this.startPoint.x,y:this.startPoint.y},rotate:r});const a=this.getMarkSize(Math.abs(n));this.path.lineTo(0,0),this.path.lineTo(0,-a.w/2),this.path.lineTo(n-a.h*s,-a.size),this.path.lineTo(n-a.h*s-a.incline*s,-a.size*2),this.path.lineTo(n,0),this.path.lineTo(n-a.h*s-a.incline*s,a.size*2),this.path.lineTo(n-a.h*s,a.size),this.path.lineTo(0,a.w/2),this.path.lineTo(0,0),this.bones=[[0,-a.size*2],[n/2,-a.size*2],[n,-a.size*2],[n,0],[n,a.size*2],[n/2,a.size*2],[0,a.size*2],[0,0]],this.type="fill",this.rotatePoint={x:0,y:0},this.draw(),this.ctx.restore()}text(t,i,e){if(this.isCreateInput=!this.isCreateInput,!this.isCreateInput)return;const o=document.createElement("input"),s=28,n=i-s/2;let r=0;o.spellcheck=!1,setTimeout(()=>o.focus(),0),this.type="fill",this.ctx.save(),o.oninput=a=>{this.clearCanvas(),this.reDraw(),this.setContextOptions({font:`${s}px auto`,textBaseline:"middle",fillStyle:f.ctx.color}),r=this.ctx.measureText(a.target.value).width,o.style.width=`${r}px`,o.style.textIndent=`${r}px`,this.bones=[[t,n],[t+r/2,n],[t+r,n],[t+r,i],[t+r,i+s/2],[t+r/2,i+s/2],[t,i+s/2],[t,i]],this.rotatePoint={x:r/2,y:s/2},this.ctx.fillText(a.target.value,t,i)},o.onblur=a=>{this.isCreateInput=!1;const d=new Path2D;d.rect(t,n,r,s),this.path={x:t,y:i,text:a.target.value,vPath:d},this.ctx.restore(),a.target.value&&this.savePath(),o.parentNode.removeChild(o)},o.style.cssText=`
        position: absolute;
        top: ${i-s/2-6}px;
        left: ${t-6}px;
        height: ${s}px;
        width: ${s}px;
        min-width: ${s}px;
        padding: 4px;
        font-size: ${s}px;
        color: transparent;
        caret-color: ${f.ctx.color};
        outline: none;
        border-radius: 4px;
        border: 2px solid ${f.ctx.color};
        background-color: transparent;
        box-shadow: inset 0px 0px 5px 2px rgba(0, 0, 0, 0);
      `,e.value.appendChild(o)}reDraw(){this.pathStore.forEach(({type:t,contextOptions:i,path:e})=>{e.text?(this.ctx.save(),this.setContextOptions(i),this.ctx.fillText(e.text,e.x,e.y),this.ctx.restore()):(this.type=t,this.contextOptions=i,this.path=e,this.draw(!0)),this.contextOptions=null})}clear(t,i){this.ctx.save(),this.path=new Path2D,this.setContextOptions({globalCompositeOperation:"destination-out"}),this.path.moveTo(this.lastPoint.x,this.lastPoint.y),this.path.lineTo(t,i),this.type="stroke",this.draw(),this.lastPoint={x:t,y:i},this.ctx.restore()}revoke(){if(!this.pathStore.length)return;this.clearCanvas();const t=this.pathStore.pop();this.revokePathStore.push(t),this.reDraw()}forward(){if(!this.revokePathStore.length)return;this.clearCanvas();const t=this.revokePathStore.pop();this.pathStore.push(t),this.reDraw()}clearCanvas(){this.ctx.clearRect(0,0,this.canvas.value.width,this.canvas.value.height)}setContextOptions(t){for(let i in t){if(i==="translate"){this.ctx[i](t[i].x,t[i].y);continue}if(i==="rotate"){this.ctx[i](t[i]);continue}this.ctx[i]=t[i]}this.contextOptions={...this.contextOptions,...t}}showBones(t,i){this.ctx.save(),this.ctx.beginPath();for(let e=0;e<=t.length;e++){const o=e%t.length,[s,n]=t[o];this.ctx.save(),this.setContextOptions({...i,lineWidth:1,fillStyle:"#fff",strokeStyle:"rgba(0, 0, 0, .8)"}),this.ctx.moveTo(s,n),this.ctx.arc(s,n,3,0,Math.PI*2),this.ctx.moveTo(s,n);const[r,a]=t[o+1]||t[0];this.ctx.lineTo(r,a),this.ctx.stroke(),this.ctx.fill(),this.ctx.restore()}this.contextOptions=null,this.ctx.closePath(),this.ctx.restore()}checkPointInPath(t){this.clearCanvas(),this.reDraw();const i=t?{x:t.x-this.lastPoint.x,y:t.y-this.lastPoint.y}:{x:0,y:0};t&&(this.lastPoint=t);for(let e=this.pathStore.length-1;e>=0;e--){const o=this.pathStore[e].path,s=this.pathStore[e].rotatePoint,n=this.pathStore[e].bones,r=this.pathStore[e].contextOptions,a=r.translate||{x:0,y:0};let d=t?t.x-a.x:this.startPoint.x-a.x,v=t?t.y-a.y:this.startPoint.y-a.y;const y=r.rotate;if(y){const h=d-s.x,k=v-s.y,P=Math.pow(h*h+k*k,1/2);d=h<0?-P:P,v=v-Math.sin(y)*(h<0?-P:P)}const c=this.ctx.isPointInPath(o.text?o.vPath:o,d,v);if(t||(this.pathStore[e].isShowBones=c),this.pathStore[e].isShowBones)return r.translate={x:t?a.x+i.x:a.x,y:t?a.y+i.y:a.y},this.pathStore[e].contextOptions=r,this.showBones(n,r)}}draw(t){this.ctx.save(),this.ctx.beginPath(),t?this.setContextOptions(this.contextOptions):this.setContextOptions({strokeStyle:f.ctx.color,fillStyle:f.ctx.color,lineWidth:f.ctx.mode==="clear"&&f.ctx.lineWidth<10?10:f.ctx.lineWidth,lineCap:f.ctx.lineCap}),this.type==="stroke"?this.ctx.stroke(this.path):this.ctx.fill(this.path),this.ctx.closePath(),this.ctx.restore()}savePath(){this.path&&(this.pathStore.push({type:this.type,rotatePoint:this.rotatePoint,contextOptions:this.contextOptions||{},path:this.path,bones:this.bones,isShowBones:!1}),this.path=null,this.bones=[],this.type="stroke",this.rotatePoint=null,this.contextOptions=null)}}return{Draw:m}}const H={class:"aside"},U=["max"],V={class:"item"},A=["onClick"],N={__name:"actionBar",props:{actions:{type:Object,required:!0}},setup(m){const l=m,t=z(),i=w(),e=w(!1),o=w(0),s=w(0),n=w(50),r=O([{icon:"icon-juxing1",type:"rect"},{icon:"icon-yuanxingweixuanzhong",type:"arc"},{icon:"icon-jiantou_youshang",type:"mark"},{icon:"icon-Icon_huabi",type:"line"},{icon:"icon-wenzi",type:"text"},{icon:"icon-chexiao",type:"revoke"},{icon:"icon-chexiao",type:"forward"},{icon:"icon-rubber-full",type:"clear"},{icon:"icon-xuanze",type:"pick"},{icon:"icon-xiazai-",type:"download"}]),a=()=>{s.value=parseInt(getComputedStyle(i.value).height)-20},d=()=>{o.value=window.innerHeight-40},v=(y,c)=>{if(["revoke","forward","download"].includes(c))return l.actions[c]();t.updateCtx(y,c)};return I(()=>{d(),B(()=>{a()}),window.addEventListener("resize",()=>{a(),d()})}),L(()=>{window.removeEventListener("resize",()=>{a(),d()})}),(y,c)=>(S(),T("aside",H,[g("div",{class:C(["tabbar-box",{collapsed:e.value}])},[g("div",{ref_key:"tabbar",ref:i,class:"tabbar",style:_({"max-height":`${o.value}px`})},[E(g("input",{class:"line-width",type:"range","onUpdate:modelValue":c[0]||(c[0]=h=>x(t).ctx.lineWidth=h),max:n.value,style:_({width:`${s.value}px`,"background-image":`linear-gradient(to right, #91caff ${x(t).ctx.lineWidth/n.value*100+"%"}, transparent ${x(t).ctx.lineWidth/100*100+"%"})`}),onChange:c[1]||(c[1]=h=>v("lineWidth",h.target.value))},null,44,U),[[M,x(t).ctx.lineWidth]]),g("div",{class:C(["item iconfont icon-wangge",{"hide-grid":!x(t).isGrid}]),onClick:c[2]||(c[2]=(...h)=>x(t).updateIsGrid&&x(t).updateIsGrid(...h))},null,2),g("div",V,[E(g("input",{class:"color",type:"color","onUpdate:modelValue":c[3]||(c[3]=h=>x(t).ctx.color=h),onChange:c[4]||(c[4]=h=>v("color",h.target.value))},null,544),[[M,x(t).ctx.color]])]),(S(!0),T(X,null,Y(r,h=>(S(),T("div",{class:C(["item iconfont",[h.icon,x(t).ctx.mode===h.type?"active":""]]),key:h.type,style:_({transform:h.type==="forward"&&"scaleX(-1)"}),onClick:G(k=>v("mode",h.type),["stop"])},null,14,A))),128))],4)],2),g("div",{class:C(["collapsed-btn iconfont icon-jiantou_yemian_xiangzuo_o",{overturn:e.value}]),onClick:c[5]||(c[5]=h=>e.value=!e.value)},null,2)]))}};const J={__name:"drawingBoard",setup(m){const l=z(),{Draw:t}=R(),i=w(),e=w(),o=w({});let s=null,n=0;const r=()=>{const{clientWidth:u,clientHeight:p}=document.documentElement;e.value.width=u,e.value.height=p,s.reDraw()},a=w(!1),d=()=>{const u=e.value.toDataURL(),p=document.createElement("a");p.setAttribute("href",u),p.setAttribute("download",Math.random().toString(16).slice(-6)),p.click()},v=()=>({revoke:()=>s.revoke(),forward:()=>s.forward(),download:d}),y=u=>{a.value=!0,n=new Date().getTime();const{clientX:p,clientY:b}=u;s.init({x:p,y:b}),l.ctx.mode==="text"&&(a.value=!1,s.text(p,b,i)),l.ctx.mode==="pick"&&s.checkPointInPath()},c=u=>{if(!a.value)return;const{clientX:p,clientY:b}=u;if(l.ctx.mode==="pick")return s.checkPointInPath({x:p,y:b});s.clearCanvas(),["line","clear"].includes(l.ctx.mode)&&s.savePath(),s.reDraw(),s[l.ctx.mode](p,b)},h=()=>{a.value=!1,new Date().getTime()-n>200&&l.ctx.mode!=="pick"&&s.savePath(),n=0},k=u=>y(u.changedTouches[0]),P=u=>c(u.changedTouches[0]),D=h,$=()=>{e.value.addEventListener("mousedown",y),e.value.addEventListener("mousemove",c),e.value.addEventListener("onmouseleave",h),e.value.addEventListener("mouseup",h),e.value.addEventListener("touchstart",k),e.value.addEventListener("touchmove",P),e.value.addEventListener("touchend",D)};return I(()=>{s=new t(e),r(),$(),o.value=v(),window.addEventListener("resize",r)}),L(()=>{e.value.removeEventListener("mousedown",y),e.value.removeEventListener("mousemove",c),e.value.removeEventListener("onmouseleave",h),e.value.removeEventListener("mouseup",h),e.value.removeEventListener("touchstart",k),e.value.removeEventListener("touchmove",P),e.value.removeEventListener("touchend",D),window.removeEventListener("resize",r)}),(u,p)=>(S(),T("main",{ref_key:"canvasRoot",ref:i,class:"canvas-root"},[g("canvas",{ref_key:"cDom",ref:e,class:C(["canvas",{"show-grid":x(l).isGrid}])},null,2),j(N,{actions:o.value},null,8,["actions"])],512))}};export{J as default};
